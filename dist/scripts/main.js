"use strict";geotab.addin.lastInsertKey=function(a,s){var t,d,c,v,r,i,l,u,n,f,o,e,m,y,p,h,g,I,w,b,S,k,K,N,B,D,L,T=document.getElementById("lastInsertKey"),E=document.querySelector(".lastInsertKey-grid"),A=T.querySelector("#lastInsertKey-runReport"),x=document.querySelector("#lastInsertKey-dateFrom"),C=document.querySelector("#lastInsertKey-sortByName"),U=document.querySelector("#lastInsertKey-sortByDate"),q=document.querySelector("#lastInsertKey-sortByType"),F=document.querySelector("#lastInsertKey-exportToXLSX"),O=document.querySelector(".alert-error"),G=function(e){O.textContent=e,O.classList.remove("hidden"),clearTimeout(t),t=setTimeout(function(){O.classList.add("hidden")},3500)},R=function(){var e,t,n=x.value,r=$.getValue();t=new Date(n),window.isNaN(t.getTime())?G('Invalid date! The correct format is "mm/dd/yyyy"'):(e=new Date(n).valueOf(),H(e,r||[]))},X=function(e){e.isAborted||G(e.message||e)},H=function(e,t){d=(new Date).valueOf(),v={},c=0,Z.show(),F.setAttribute("disabled","disabled"),e?M(e,null,t):a.call("GetCountOf",{typeName:"DriverChange"},function(e){M(null,e,t)},X)},M=function t(n,r,i){var e,l=new Date(d),o=0===i.length?null:i.reduce(function(e,t){return e[t]=!0,e},{});d-=12096e5,e={fromDate:new Date(Math.max(d,n)).toISOString(),toDate:l.toISOString(),userSearch:{DriverGroups:s.getGroupFilter()}},1===i.length&&(e.userSearch.id=i[0]),a.call("Get",{typeName:"DriverChange",search:e},function(e){e=z(e,o),_(e,i),null!==n&&n<=d||null!==r&&c<r?t(n,r,i):(Z.hide(),F.removeAttribute("disabled"))},X)},z=function(e,t){return t?e.filter(function(e){return!!t[e.driver.id]}):e},_=function(e){var n,t,r,i=(r=0,{increase:function(){r++},decrease:function(){r--},isComplete:function(){return 0===r}}),l=(n={},{devices:(t=function(t){return{sent:function(e){n[t+e]=!0},complete:function(e){delete n[t+e]},isRequestSent:function(e){return!!n[t+e]}}})("device_"),drivers:t("driver_")}),o=function(){i.isComplete()&&(e.forEach(function(e){var t="UnknownDriverId"!==e.driver?e.driver.id:null,n=V.getItemById(t),r=e.device?e.device.id:null,i=J.getItemById(r);e.driver=n||"UnknownDriverId",e.device=i}),Q(P(v)))};e.forEach(function(e){var t="UnknownDriverId"!==e.driver?e.driver.id:null,n=e.device?e.device.id:null;(!v[t]||e.dateTime>v[t].dateTime)&&(v[t]=e,t&&(V.getItemById(t)||l.drivers.isRequestSent(t)||(l.drivers.sent(t),a.call("Get",{typeName:"User",search:{id:t}},function(e){e&&e[0]&&V.add(e),l.drivers.complete(t),i.decrease(),o()},function(e){l.drivers.complete(t),X(e)}),i.increase())),n&&(J.getItemById(n)||l.devices.isRequestSent(n)||(l.devices.sent(n),a.call("Get",{typeName:"Device",search:{id:n}},function(e){e&&e[0]&&J.add(e),l.devices.complete(n),i.decrease(),o()},function(e){l.devices.complete(n),X(e)}),i.increase()))),c++}),o()},j=function(){var r={};return{add:function(e){var t,n;for(n=0;n<e.length;n++)t=e[n],r[t.id]=t},clear:function(){r={}},getItemById:function(e){return r[e]||null}}},V=j(),J=j(),P=function(e){var t,n=Object.keys(e),r=[];for(t=0;t<n.length;t++)r.push(e[n[t]]);return r},Q=function(e){var t,n,r,i,l="";if(e=e.sort(ee.getSortBy()),E.innerHTML="",0<e.length)for(n=0;n<e.length;n++)r="<div class='lastInsertKey-row'>",r+="<div class='lastInsertKey-cell-name' title='Driver'>"+((t=e[n]).driver&&"UnknownDriverId"!==t.driver?t.driver.name:"Unknown driver")+" ("+(t.device?t.device.name:"")+")</div>",r+="<div class='lastInsertKey-cell-secondary'>",r+="<div class='lastInsertKey-cell-info lastInsertKey-cell-right lastInsertKey-cell-wide' title='Date of the last change'>"+((i=new Date(t.dateTime)).toLocaleDateString()+" "+i.toLocaleTimeString().replace(/:\d+ /," "))+"</div>",r+="<div class='lastInsertKey-cell-info lastInsertKey-cell-right' title='Type of the driver change'>"+t.type+"</div>",l+=r+="</div></div>";else l="<div class='lastInsertKey-row'><div class='lastInsertKey-cell-name'>There is no driver changes in selected period.</div></div>";E.innerHTML+=l},W=function(e,t){e.className+=" "+t},Y=function(e,t){var n=new RegExp(" "+t,"g");e.className=e.className.replace(n,"")},Z=(D=T.querySelector("#lastInsertKey-progress"),L=null,{show:function(){L=window.setTimeout(function(){D.style.display="block",L=null},100)},hide:function(){L&&(window.clearTimeout(L),L=null),D.style.display="none"}}),$=(u=document.querySelector(".lastInsertKey-drivers"),n=function(e,t){var n={isDriver:!0,driverGroups:s.getGroupFilter()};0<e.length&&(n.name="%"+e+"%"),a.call("Get",{typeName:"User",search:n,resultsLimit:100},function(e){$.setOptions(e),t()},X)},f=document.createElement("input"),o=document.createElement("div"),e=document.createElement("div"),m=[],y=function(e){var t,n,r="";for(n=0;n<e.length;n++)r+="<div class='lastInsertKey-option' data-item-id='"+(t=e[n]).id+"'>"+t.name+"</div>";o.innerHTML=r},p={},h=function(){var e,t=document.body.offsetHeight;"block"!==o.style.display&&(o.style.maxHeight="none",o.style.display="block",Y(o,"lastInsertKey-options-upper")),(e=o.getBoundingClientRect()).top+e.height>t&&(o.style.maxHeight=t-e.top-6+"px"),t-(e=o.getBoundingClientRect()).top<60&&(o.style.maxHeight="none",W(o,"lastInsertKey-options-upper"),(e=o.getBoundingClientRect()).top<0&&(o.style.maxHeight=e.bottom-46+"px"))},g=function(){Array.prototype.forEach.call(o.childNodes,function(e){var t=e.getAttribute("data-item-id");p[t]?W(e,"lastInsertKey-selected"):Y(e,"lastInsertKey-selected")})},I=function(e){for(;e;){if(null!==e.getAttribute("data-item-id"))return e;if(e===o)return null;e=e.parentNode}return null},w=function(e){var t,n,r,i,l,o;if(e&&!p[e]){for(n=0;n<m.length;n++)if(m[n].id===e){t=m[n];break}t&&(r=t,i=document.createElement("div"),l=document.createElement("div"),o=null,i.className="lastInsertKey-marker",i.appendChild(document.createTextNode(r.name)),l.className="lastInsertKey-remove-icon",i.appendChild(l),l.addEventListener("click",function e(){o||(o=window.setTimeout(function(){l.removeEventListener("click",e,!1),i.parentNode.removeChild(i),o=l=i=null,delete p[r.id],g(),B()},1))},!1),u.insertBefore(i,f),p[r.id]=i,g(),N(),g())}},b=function(e){for(var t=!1;e;){if(e===u){t=!0;break}e=e.parentNode}return t},S=function(e){b(e.target)||(o.style.display="none")},k=function(e){var n=[],r=null;Array.prototype.forEach.call(o.childNodes,function(e,t){e.className&&-1===e.className.indexOf("lastInsertKey-selected")&&n.push(t),e.className&&-1<e.className.indexOf("hover")&&(r=n.length-1)}),0<n.length&&(null===r&&(r=-1),(r+=e)<0&&(r=n.length-1),r>n.length-1&&(r=0),r=n[r]),Array.prototype.forEach.call(o.childNodes,function(e,t){t===r?W(e,"hover"):Y(e,"hover")})},K=function(){var e,t=o.querySelector(".hover");t&&(e=t.getAttribute("data-item-id"),w(e))},N=function(){e.style.display="none"},B=function(){0===u.querySelectorAll(".lastInsertKey-marker").length&&0===f.value.length&&(e.style.display="block")},u.className="lastInsertKey-autocomplete",o.className="lastInsertKey-options-list",f.className="lastInsertKey-search",e.className="lastInsertKey-placeholder",e.appendChild(document.createTextNode("All drivers")),u.appendChild(e),u.appendChild(f),u.appendChild(o),u.addEventListener("click",function(e){b(e.target)&&("block"!==o.style.display&&window.setTimeout(h,1),f.focus())},!1),f.addEventListener("keyup",function(){var e=f.value.length;f.style.width=Math.max(4,.9*e)+"em"},!1),f.addEventListener("keyup",function(e){switch(e?e.keyCode:null){case 38:k(-1);break;case 40:k(1);break;case 13:K(e);break;default:window.setTimeout(function(){var e=(f.value||"").trim();n(e,function(){y(m),g(),h()}),g(),h()},50)}},!1),o.addEventListener("click",function(e){var t=I(e.target).getAttribute("data-item-id");w(t)},!1),o.addEventListener("mousemove",function(e){var t=I(e.target);Array.prototype.forEach.call(o.childNodes,function(e){e===t?W(e,"hover"):Y(e,"hover")})},!1),f.addEventListener("focus",function(){window.setTimeout(h,1),N()},!1),f.addEventListener("blur",function(){window.setTimeout(function(){B()},100)},!1),{getValue:function(){return Object.keys(p)},setOptions:function(e){y(m=e)},focus:function(){document.body.addEventListener("click",S,!1)},blur:function(){document.body.removeEventListener("click",S,!1)}}),ee=(r=1,i="name",l={name:function(e,t){var n=(e.driver&&"UnknownDriverId"!==e.driver&&e.driver.name?e.driver.name:"Unknown Driver").toLowerCase();return(t.driver&&"UnknownDriverId"!==t.driver&&t.driver.name?t.driver.name:"Unknown Driver").toLowerCase()<n?1:-1},date:function(e,t){return e.dateTime>t.dateTime?1:-1},type:function(e,t){return e.type===t.type?e.name>t.name?-1:1:e.type>t.type?-1:1}},{setSortBy:function(e){return!!l[e]&&(e!==i?(r=1,i=e):r*=-1,!0)},getSortBy:function(){var n=l[i]?l[i]:l.name;return function(e,t){return n(e,t)*r}}}),te=function(){ee.setSortBy("name"),v&&Q(P(v))},ne=function(){ee.setSortBy("date"),v&&Q(P(v))},re=function(){ee.setSortBy("type"),v&&Q(P(v))},ie=function(){var e,t,n,r,i,l,o,a,s=new function(){this.SheetNames=[],this.Sheets={}},d={},c={horizontal:"left"},u=[{applyFill:"1",applyBorder:"1",borderId:"0",fillId:"2",fontId:"1",numFmtId:0,xfId:"0",applyAlignment:"1",alignment:c},{applyFill:"1",applyBorder:"1",borderId:"0",fillId:"2",fontId:"2",numFmtId:0,xfId:"0"},{applyFill:"1",applyBorder:"1",borderId:"0",fillId:"2",fontId:"2",numFmtId:0,xfId:"0",applyAlignment:"1",alignment:{horizontal:"right"}},{applyFill:"1",applyBorder:"1",borderId:"0",fillId:"2",fontId:"1",numFmtId:"15",xfId:"0",applyAlignment:"1",alignment:c},{applyFill:"1",applyBorder:"1",borderId:"0",fillId:"2",fontId:"1",numFmtId:"25",xfId:"0",alignment:c}];for(d["!cols"]=[{wch:35},{wch:25},{wch:20}],d["!ref"]=XLSX.utils.encode_range({s:{c:0,r:0},e:{c:2,r:65536}}),d["!frozen"]=4,d.A1={v:"Created",s:2},d.B1={v:new Date,s:3,t:"d"},d.A2={v:"Total",s:2},d.B2={v:"",f:"COUNTA(A5:A65536)",t:"n"},d.A4={v:"Driver",s:1},d.B4={v:"Date",s:1},d.C4={v:"Type",s:1},n=(n=P(v)).sort(ee.getSortBy()),t=0;t<n.length;t++)i=(r=n[t]).driver&&"UnknownDriverId"!==r.driver&&r.driver.name?r.driver.name:"Unknown driver",l=new Date(r.dateTime),o=r.type,d["A"+(a=XLSX.utils.encode_row(4+t))]={v:i},d["B"+a]={v:l,s:4,t:"d"},d["C"+a]={v:o};s.SheetNames.push("Report"),s.Sheets.Report=d,e=XLSX.write(s,{bookType:"xlsx",bookSST:!0,type:"binary",cellXfs:u,fills:[{fgColor:"ffffff"}]}),saveAs(new Blob([function(e){for(var t=new ArrayBuffer(e.length),n=new Uint8Array(t),r=0;r!=e.length;++r)n[r]=255&e.charCodeAt(r);return t}(e)],{type:"application/octet-stream"}),"LastInsertKeyReport.xlsx")};return{initialize:function(e,t,n){n&&n(),A.addEventListener("click",R,!1),C.addEventListener("click",te,!1),U.addEventListener("click",ne,!1),q.addEventListener("click",re,!1),void 0!==window.Blob?F.addEventListener("click",ie,!1):F.style.display="none"},focus:function(){var e;T.className="",a.call("Get",{typeName:"User",search:{isDriver:!0,driverGroups:s.getGroupFilter()},resultsLimit:100},function(e){$.setOptions(e),V.add(e)},X),e=(new Date).toISOString(),x.setAttribute("max",e.substr(0,10)),$.focus()},blur:function(){Z.hide(),$.blur()}}};